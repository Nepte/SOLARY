<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Carte des bornes</title>
    <style>
        html, body, #map, #map3d {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
            position: fixed;
            overflow: hidden;
        }

        /* Style pour les marqueurs de bornes */
        .station-marker {
            width: 36px;
            height: 36px;
            background-color: #FFD602;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            will-change: transform;
        }

            .station-marker::after {
                content: '';
                width: 24px;
                height: 24px;
                background-color: white;
                border-radius: 50%;
                transform: rotate(45deg);
                box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
            }

            .station-marker:hover {
                transform: rotate(-45deg) scale(1.1);
                box-shadow: 0 5px 12px rgba(0,0,0,0.5);
            }

            .station-marker.available {
                background-color: #4CAF50; /* Vert pour disponible */
            }

            .station-marker.occupied {
                background-color: #FFD602; /* Jaune pour occupé */
            }

            .station-marker.maintenance {
                background-color: #F44336; /* Rouge pour maintenance */
            }

        /* Style pour les marqueurs 3D */
        .marker-3d {
            width: 36px;
            height: 36px;
            cursor: pointer;
            position: relative;
        }

            .marker-3d .station-marker {
                position: absolute;
                top: 0;
                left: 0;
                width: 36px;
                height: 36px;
            }

        /* Style pour les popups - MODIFIÉ pour un format plus carré */
        .leaflet-popup-content-wrapper {
            padding: 0;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: none;
            background: transparent;
            max-width: 180px; /* Augmenté pour plus de largeur */
            width: auto !important;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: 0;
            width: auto !important;
            max-width: 180px; /* Augmenté pour plus de largeur */
            background: transparent;
        }

        .leaflet-popup-tip {
            background-color: white;
        }

        .leaflet-popup-close-button {
            color: rgba(255,255,255,0.9) !important;
            margin: 4px 4px 0 0 !important;
            font-size: 12px !important;
            font-weight: 300 !important;
            width: 16px !important;
            height: 16px !important;
            background: rgba(0,0,0,0.2) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10 !important;
        }

            .leaflet-popup-close-button:hover {
                color: white !important;
                background: rgba(0,0,0,0.4) !important;
            }

        /* Correction du positionnement des popups */
        .leaflet-popup {
            margin-bottom: 20px !important;
            max-height: 90vh;
            overflow: visible;
            pointer-events: auto !important;
        }

            /* Ajout d'une classe pour les popups qui dépassent de la carte */
            .leaflet-popup.popup-overflow {
                max-height: 80vh;
                overflow-y: auto;
            }

        .station-popup {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 180px; /* Augmenté pour plus de largeur */
        }

        .station-popup-header {
            padding: 6px;
            background-color: #333;
            color: white;
        }

            .station-popup-header h3 {
                margin: 0 0 2px 0;
                font-size: 12px;
                font-weight: 600;
                letter-spacing: -0.2px;
                color: white;
            }

            .station-popup-header p {
                margin: 0;
                font-size: 9px; /* Réduit davantage */
                color: rgba(255,255,255,0.7);
                font-weight: 400;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        .station-popup-body {
            padding: 6px;
            background-color: white;
            color: #333333;
            border-radius: 0 0 10px 10px;
        }

        .power-info {
            display: flex;
            align-items: center;
            margin-bottom: 4px; /* Réduit davantage */
        }

        .power-icon {
            width: 20px; /* Réduit davantage */
            height: 20px; /* Réduit davantage */
            background-color: #FFD602;
            border-radius: 5px; /* Réduit davantage */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px; /* Réduit davantage */
            flex-shrink: 0;
        }

            .power-icon svg {
                width: 12px; /* Réduit davantage */
                height: 12px; /* Réduit davantage */
                fill: #333;
            }

        .power-value {
            font-size: 12px; /* Réduit davantage */
            font-weight: 600;
            color: #333;
            margin-right: 3px; /* Réduit davantage */
        }

        .power-badge {
            background-color: #f0f0f0;
            color: #333;
            font-size: 7px; /* Réduit davantage */
            font-weight: 600;
            padding: 1px 4px; /* Réduit davantage */
            border-radius: 6px; /* Réduit davantage */
            margin-left: auto;
        }

        .status-label {
            font-size: 9px; /* Réduit davantage */
            color: #666;
            margin-bottom: 1px; /* Réduit davantage */
        }

        .status-value {
            font-size: 12px; /* Réduit davantage */
            font-weight: 600;
            margin-bottom: 3px; /* Réduit davantage */
        }

        .status-available {
            color: #4CAF50;
        }

        .status-occupied {
            color: #FFD602;
        }

        .status-maintenance {
            color: #F44336;
        }

        .progress-container {
            height: 3px; /* Réduit davantage */
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1px; /* Réduit davantage */
        }

        .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

            .progress-fill.available {
                background: linear-gradient(90deg, #4CAF50, #8BC34A);
            }

            .progress-fill.occupied {
                background: linear-gradient(90deg, #FFD602, #FFC107);
            }

            .progress-fill.maintenance {
                background: linear-gradient(90deg, #F44336, #FF5722);
            }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 7px; /* Réduit davantage */
            color: #999;
            margin-bottom: 3px; /* Ajouté pour réduire l'espace */
        }

        .usage-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 5px; /* Réduit davantage */
            padding-top: 5px; /* Réduit davantage */
            border-top: 1px solid #f0f0f0;
        }

        .usage-label {
            color: #666;
            font-size: 9px; /* Réduit davantage */
        }

        .last-usage {
            display: inline-block;
            background-color: #333;
            color: white;
            font-size: 8px; /* Réduit davantage */
            font-weight: 500;
            padding: 1px 5px; /* Réduit davantage */
            border-radius: 6px; /* Réduit davantage */
        }

            .last-usage.unavailable {
                background-color: #f0f0f0;
                color: #666;
            }

        /* Style pour le bouton de navigation */
        .navigation-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            color: white;
            font-size: 9px; /* Réduit davantage */
            font-weight: 600;
            padding: 5px 8px; /* Réduit davantage */
            border-radius: 12px; /* Réduit davantage */
            margin-top: 5px; /* Réduit davantage */
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            width: 100%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

            .navigation-button:hover {
                background-color: #555;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            .navigation-button svg {
                width: 10px; /* Réduit davantage */
                height: 10px; /* Réduit davantage */
                margin-right: 3px; /* Réduit davantage */
                fill: currentColor;
            }

        /* Attribution de la carte */
        .leaflet-control-attribution {
            font-size: 9px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Indicateur de chargement */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            display: none;
        }

        /* Animation de pulsation pour les marqueurs */
        @keyframes pulse {
            0% {
                transform: rotate(-45deg) scale(1);
            }

            50% {
                transform: rotate(-45deg) scale(1.1);
            }

            100% {
                transform: rotate(-45deg) scale(1);
            }
        }

        .station-marker.pulse {
            animation: pulse 1.5s infinite;
        }

        /* Amélioration de la fluidité des animations */
        .leaflet-fade-anim .leaflet-tile,
        .leaflet-fade-anim .leaflet-popup {
            will-change: opacity;
            backface-visibility: hidden;
        }

        .leaflet-zoom-anim .leaflet-zoom-animated {
            will-change: transform;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }

        /* Optimisations pour le défilement */
        .leaflet-container {
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
        }

        /* Style pour le mode 3D */
        .maplibregl-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Contrôles 3D */
        .maplibregl-ctrl-top-right {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .maplibregl-ctrl-group {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .maplibregl-ctrl button {
            width: 30px;
            height: 30px;
            display: block;
            padding: 0;
            outline: none;
            border: 0;
            box-sizing: border-box;
            background-color: transparent;
            cursor: pointer;
        }

        /* Indicateur de mode 3D */
        .mode-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease;
        }

        /* Style pour les marqueurs 3D */
        .maplibregl-marker {
            will-change: transform;
        }

        /* Style pour les popups 3D - MODIFIÉ pour correspondre aux changements 2D */
        .maplibregl-popup {
            z-index: 1;
            max-width: 180px !important; /* Augmenté pour plus de largeur */
        }

        .maplibregl-popup-content {
            padding: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 180px !important; /* Augmenté pour plus de largeur */
        }

        .maplibregl-popup-close-button {
            color: rgba(255,255,255,0.9);
            font-size: 12px;
            font-weight: 300;
            width: 16px;
            height: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px 4px 0 0;
            padding: 0;
            border: none;
            cursor: pointer;
        }

            .maplibregl-popup-close-button:hover {
                color: white;
                background: rgba(0,0,0,0.4);
            }

        /* Adaptation pour les petits écrans */
        @media (max-width: 480px) {
            .station-popup {
                max-width: 170px; /* Augmenté mais toujours adapté pour mobile */
            }

            .leaflet-popup-content-wrapper,
            .leaflet-popup-content {
                max-width: 170px; /* Augmenté mais toujours adapté pour mobile */
            }

            .power-value {
                font-size: 11px;
            }

            .status-value {
                font-size: 11px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MapLibre GL JS pour la vue 3D -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
</head>
<body>
    <div id="map"></div>
    <div id="map3d" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>

    <!-- Indicateur de chargement -->
    <div class="loading-indicator" id="loading-indicator">Chargement...</div>

    <!-- Indicateur de mode -->
    <div class="mode-indicator" id="mode-indicator">Mode 3D activé</div>

    <!-- Load Leaflet from CDN -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MapLibre GL JS pour la vue 3D -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <script>
        // Initialiser la carte avec un style standard
        var map = null;
        var map3d = null;

        // Données des bornes - sera remplacé par les données réelles de l'API
        var stationData = [];

        // Variable pour la vue 3D
        window.is3DView = false;

        // Variable pour stocker le popup actuellement ouvert
        var currentOpenPopup = null;

        // Variable pour éviter les animations multiples
        var isAnimating = false;

        // Variable pour suivre si la carte est initialisée
        var mapInitialized = false;
        var map3dInitialized = false;

        // Variables pour les marqueurs 3D
        var markers3D = [];

        // Variables globales pour les marqueurs
        var markers = [];
        var markerLayer = null;
        var activeMarkerId = null;

        // Variables pour la mise à jour en temps réel
        var updateInterval = null;
        var lastUpdateTimestamp = 0;
        var realTimeUpdateEnabled = false;

        // Fonction pour détecter les obstructions UI - CORRIGÉE selon l'interface SOLARY
        function detectUIObstructions() {
            var obstructions = {
                top: 0,
                bottom: 0,
                left: 0,
                right: 0
            };

            try {
                var windowHeight = window.innerHeight;
                var windowWidth = window.innerWidth;

                // Basé sur l'interface SOLARY visible dans la capture d'écran
                obstructions.top = 100; // Barre de recherche + marge
                obstructions.right = 70; // Boutons zoom, position, menu
                obstructions.bottom = 150; // Boutons en bas et section proximité (réduit pour meilleur centrage)
                obstructions.left = 0; // Pas d'obstruction à gauche

                console.log("Obstructions UI SOLARY détectées:", obstructions);
            } catch (e) {
                console.error("Erreur lors de la détection des obstructions UI:", e);
                // Valeurs par défaut sécurisées pour l'interface SOLARY
                obstructions.top = 100;
                obstructions.bottom = 150;
                obstructions.right = 70;
                obstructions.left = 0;
            }

            return obstructions;
        }

        // Fonction pour calculer la zone visible sûre pour les popups
        function getSafeViewArea() {
            var obstructions = detectUIObstructions();
            var mapContainer = map.getContainer();
            var mapRect = mapContainer.getBoundingClientRect();

            var safeArea = {
                top: obstructions.top,
                bottom: mapRect.height - obstructions.bottom,
                left: obstructions.left,
                right: mapRect.width - obstructions.right,
                height: mapRect.height - obstructions.top - obstructions.bottom,
                width: mapRect.width - obstructions.left - obstructions.right
            };

            // Calculer le centre EXACT de la zone sûre
            safeArea.centerY = safeArea.top + (safeArea.height / 2);
            safeArea.centerX = safeArea.left + (safeArea.width / 2);

            console.log("Zone sûre calculée:", safeArea);
            return safeArea;
        }

        // NOUVELLE FONCTION: Centrage parfait au milieu de la zone visible
        function centerMarkerPerfectly(marker) {
            if (!map || !marker) return;

            var markerLatLng = marker.getLatLng();
            var safeArea = getSafeViewArea();

            console.log("=== CENTRAGE PARFAIT DU MARQUEUR ===");
            console.log("Position du marqueur:", markerLatLng);
            console.log("Zone sûre:", safeArea);

            // D'abord, centrer la carte sur le marqueur
            map.setView(markerLatLng, 17, {
                animate: true,
                duration: 0.8,
                easeLinearity: 0.2
            });

            // Attendre que l'animation soit terminée
            setTimeout(function () {
                // Obtenir la position actuelle du marqueur en pixels
                var markerPixel = map.latLngToContainerPoint(markerLatLng);
                console.log("Position actuelle du marqueur en pixels:", markerPixel);

                // Calculer le décalage nécessaire pour centrer parfaitement
                var offsetX = safeArea.centerX - markerPixel.x;
                var offsetY = safeArea.centerY - markerPixel.y;

                console.log("Décalage nécessaire:", { x: offsetX, y: offsetY });

                // Appliquer le décalage pour centrer parfaitement le marqueur
                if (Math.abs(offsetX) > 2 || Math.abs(offsetY) > 2) {
                    map.panBy([offsetX, offsetY], {
                        animate: true,
                        duration: 0.4,
                        easeLinearity: 0.2
                    });
                }

                // Ouvrir le popup après le centrage parfait
                setTimeout(function () {
                    marker.openPopup();
                    currentOpenPopup = marker.getPopup();

                    // Vérifier et ajuster le popup si nécessaire
                    setTimeout(function () {
                        adjustPopupPosition(marker.getPopup());
                    }, 150);
                }, 450);
            }, 850);
        }

        // Fonction pour ajuster la position du popup pour qu'il soit entièrement visible
        function adjustPopupPosition(popup) {
            if (!popup || !popup._container) return;

            var safeArea = getSafeViewArea();
            var popupRect = popup._container.getBoundingClientRect();
            var mapRect = map.getContainer().getBoundingClientRect();

            // Coordonnées du popup relatives à la carte
            var popupTop = popupRect.top - mapRect.top;
            var popupBottom = popupRect.bottom - mapRect.top;
            var popupLeft = popupRect.left - mapRect.left;
            var popupRight = popupRect.right - mapRect.left;

            console.log("Position du popup:", {
                top: popupTop,
                bottom: popupBottom,
                left: popupLeft,
                right: popupRight
            });

            // Calculer les ajustements nécessaires
            var adjustX = 0;
            var adjustY = 0;

            // Vérifier si le popup dépasse en haut
            if (popupTop < safeArea.top) {
                adjustY = safeArea.top - popupTop + 10;
                console.log("Popup trop haut, ajustement Y:", adjustY);
            }

            // Vérifier si le popup dépasse en bas
            if (popupBottom > safeArea.bottom) {
                adjustY = safeArea.bottom - popupBottom - 10;
                console.log("Popup trop bas, ajustement Y:", adjustY);
            }

            // Vérifier si le popup dépasse à droite
            if (popupRight > safeArea.right) {
                adjustX = safeArea.right - popupRight - 10;
                console.log("Popup trop à droite, ajustement X:", adjustX);
            }

            // Vérifier si le popup dépasse à gauche
            if (popupLeft < safeArea.left) {
                adjustX = safeArea.left - popupLeft + 10;
                console.log("Popup trop à gauche, ajustement X:", adjustX);
            }

            // Appliquer l'ajustement si nécessaire
            if (adjustX !== 0 || adjustY !== 0) {
                console.log("Ajustement final du popup:", { x: adjustX, y: adjustY });
                map.panBy(new L.Point(-adjustX, -adjustY), {
                    animate: true,
                    duration: 0.3,
                    easeLinearity: 0.2,
                    noMoveStart: true
                });
            }
        }

        // SYSTÈME DE MISE À JOUR EN TEMPS RÉEL
        function startRealTimeUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }

            // Vérifier les mises à jour toutes les 5 secondes
            updateInterval = setInterval(function () {
                checkForUpdates();
            }, 5000);

            realTimeUpdateEnabled = true;
            console.log("Système de mise à jour en temps réel démarré");
        }

        function stopRealTimeUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            realTimeUpdateEnabled = false;
            console.log("Système de mise à jour en temps réel arrêté");
        }

        function checkForUpdates() {
            // Demander à l'application native de vérifier les mises à jour
            notifyNative('checkUpdates', {
                lastUpdate: lastUpdateTimestamp
            });
        }

        // Fonction appelée par l'application native quand il y a des mises à jour
        function handleRealTimeUpdate(newData, timestamp) {
            if (!newData || !Array.isArray(newData)) return;

            if (timestamp > lastUpdateTimestamp) {
                console.log("Mise à jour en temps réel reçue:", newData.length, "stations");
                lastUpdateTimestamp = timestamp;

                // Mettre à jour les données sans recharger la page
                updateStationDataRealTime(newData);
            }
        }

        // Mise à jour en temps réel des données
        function updateStationDataRealTime(newData) {
            try {
                var previousActiveId = activeMarkerId;
                stationData = newData;

                // Adapter les propriétés
                for (let i = 0; i < stationData.length; i++) {
                    adaptStationProperties(stationData[i]);
                }

                // Mettre à jour les marqueurs sans animation perturbante
                if (map && markerLayer && !window.is3DView) {
                    markerLayer.clearLayers();
                    markers = [];

                    stationData.forEach(function (station) {
                        if (station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng))) {
                            var marker = createStationMarker(station);
                            if (marker) {
                                markers.push(marker);
                                markerLayer.addLayer(marker);
                            }
                        }
                    });

                    // Restaurer la station active si elle existe toujours
                    if (previousActiveId !== null) {
                        var activeStation = stationData.find(function (s) {
                            return s.id === previousActiveId || s.borne_id === previousActiveId;
                        });
                        if (activeStation) {
                            setTimeout(function () {
                                var activeMarker = markers.find(function (m) {
                                    return m.options.stationId === previousActiveId;
                                });
                                if (activeMarker && currentOpenPopup) {
                                    activeMarker.openPopup();
                                }
                            }, 100);
                        }
                    }
                }

                // Mettre à jour les marqueurs 3D
                if (map3d && map3dInitialized && window.is3DView) {
                    refreshMarkers3D();
                }

                console.log("Mise à jour en temps réel terminée");
            } catch (e) {
                console.error("Erreur lors de la mise à jour en temps réel:", e);
            }
        }

        // Fonction pour centrer la carte sur un marqueur et ouvrir son popup
        function centerMapAndOpenPopup(marker) {
            if (!map || !marker || isAnimating) return;

            console.log("=== DÉBUT DU PROCESSUS DE CENTRAGE ===");
            isAnimating = true;

            // Fermer tous les popups existants
            closeAllPopups();

            // Utiliser le nouveau centrage parfait
            centerMarkerPerfectly(marker);

            // Réinitialiser le flag d'animation après un délai
            setTimeout(function () {
                isAnimating = false;
            }, 1500);
        }

        // Fonction pour vérifier si un popup dépasse de la carte
        function checkPopupOverflow(popup) {
            if (!popup || !popup._container) return;

            var container = popup._container;
            var safeArea = getSafeViewArea();
            var popupRect = container.getBoundingClientRect();
            var mapRect = map.getContainer().getBoundingClientRect();

            // Convertir en coordonnées relatives à la carte
            var popupTop = popupRect.top - mapRect.top;
            var popupBottom = popupRect.bottom - mapRect.top;

            // Si le popup dépasse de la zone sûre
            if (popupTop < safeArea.top || popupBottom > safeArea.bottom) {
                L.DomUtil.addClass(container, 'popup-overflow');
            } else {
                L.DomUtil.removeClass(container, 'popup-overflow');
            }
        }

        // Fonction pour initialiser la carte
        function initMap() {
            try {
                console.log("Initialisation de la carte...");

                // Créer l'instance de la carte avec des options pour améliorer la fluidité
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: true,
                    minZoom: 5,
                    maxZoom: 19,
                    zoomSnap: 0.25,
                    zoomDelta: 0.25,
                    wheelPxPerZoomLevel: 120,
                    fadeAnimation: true,
                    markerZoomAnimation: true,
                    inertia: true,
                    inertiaDeceleration: 3000,
                    easeLinearity: 0.2,
                    worldCopyJump: true,
                    preferCanvas: true,
                    tap: true,
                    bounceAtZoomLimits: false,
                    renderer: L.canvas({ padding: 0.5 })
                });

                console.log("Carte créée");

                // Ajouter la couche de tuiles OpenStreetMap standard
                var standardTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    maxNativeZoom: 19,
                    tileSize: 256,
                    updateWhenIdle: false,
                    updateWhenZooming: true,
                    keepBuffer: 6
                }).addTo(map);

                console.log("Couche de tuiles ajoutée");

                // Ajouter les marqueurs initiaux et centrer la carte
                addMarkersToMap();

                // Notifier que la carte est prête
                notifyNative('mapReady', {});

                console.log("Carte initialisée avec succès");

                // Forcer un rafraîchissement de la carte
                setTimeout(function () {
                    if (map) {
                        map.invalidateSize();
                        console.log("Taille de la carte rafraîchie");
                    }
                }, 500);

                // Ajouter un écouteur d'événement pour fermer les popups lors d'un clic sur la carte
                map.on('click', function () {
                    closeAllPopups();
                });

                // Gestion améliorée de l'ouverture des popups
                map.on('popupopen', function (e) {
                    // Stocker le popup actuellement ouvert
                    currentOpenPopup = e.popup;

                    // Vérifier si le popup dépasse de la carte
                    checkPopupOverflow(e.popup);
                });

                // Optimiser la gestion des popups sur mobile
                if (L.Browser.mobile) {
                    map.on('popupopen', function (e) {
                        var container = e.popup._container;
                        if (container) {
                            // Empêcher le défilement de la carte lors du défilement dans le popup
                            L.DomEvent.disableClickPropagation(container);
                            L.DomEvent.disableScrollPropagation(container);
                        }
                    });
                }

                // Optimiser le défilement sur les appareils mobiles
                if (L.Browser.touch) {
                    L.DomEvent.disableClickPropagation(document.getElementById('map'));
                    L.DomEvent.disableScrollPropagation(document.getElementById('map'));
                }

                mapInitialized = true;

                // Démarrer les mises à jour en temps réel
                startRealTimeUpdates();

                return true;
            } catch (e) {
                console.error("Erreur lors de l'initialisation de la carte:", e);
                notifyNative('error', { message: e.message, source: 'initMap', line: 0 });
                return false;
            }
        }

        // Fonction pour initialiser la carte 3D
        function initMap3D() {
            try {
                if (map3dInitialized && map3d) {
                    document.getElementById('map3d').style.display = 'block';
                    refreshMarkers3D();
                    return true;
                }

                console.log("Initialisation de la carte 3D...");
                showLoading();

                maplibregl.setRTLTextPlugin(
                    'https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js',
                    null,
                    true
                );

                var center = [6.129, 45.899];
                var zoom = 14;

                if (map && mapInitialized) {
                    var mapCenter = map.getCenter();
                    center = [mapCenter.lng, mapCenter.lat];
                    zoom = map.getZoom();
                }

                map3d = new maplibregl.Map({
                    container: 'map3d',
                    style: 'https://api.maptiler.com/maps/streets/style.json?key=tsPaLJ6DWZPxMNaJ2DV7',
                    center: center,
                    zoom: zoom,
                    pitch: 45,
                    bearing: 0,
                    antialias: true,
                    attributionControl: false,
                    renderWorldCopies: true,
                    maxPitch: 85,
                    minPitch: 0,
                    maxZoom: 22,
                    minZoom: 0,
                    dragRotate: true,
                    touchZoomRotate: true,
                    touchPitch: true,
                    cooperativeGestures: false,
                    fadeDuration: 300,
                    optimizeForTerrain: true
                });

                map3d.addControl(new maplibregl.NavigationControl({
                    showCompass: true,
                    showZoom: true,
                    visualizePitch: true
                }));

                map3d.addControl(new maplibregl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true,
                    showAccuracyCircle: true,
                    showUserLocation: true
                }));

                map3d.on('load', function () {
                    map3d.addSource('openmaptiles', {
                        type: 'vector',
                        url: 'https://api.maptiler.com/tiles/v3/tiles.json?key=tsPaLJ6DWZPxMNaJ2DV7'
                    });

                    map3d.addLayer({
                        'id': 'building-3d',
                        'source': 'openmaptiles',
                        'source-layer': 'building',
                        'type': 'fill-extrusion',
                        'minzoom': 14,
                        'paint': {
                            'fill-extrusion-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'height'],
                                0, '#CCCCCC',
                                50, '#999999',
                                100, '#666666'
                            ],
                            'fill-extrusion-height': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 0,
                                16, ['*', ['get', 'height', 10], 1.2]
                            ],
                            'fill-extrusion-base': 0,
                            'fill-extrusion-opacity': 0.8
                        }
                    });

                    map3d.addLayer({
                        'id': 'road-3d',
                        'source': 'openmaptiles',
                        'source-layer': 'transportation',
                        'type': 'line',
                        'minzoom': 14,
                        'paint': {
                            'line-width': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 1,
                                18, 12
                            ],
                            'line-color': '#ffffff',
                            'line-opacity': 0.8
                        }
                    });

                    addMarkers3D();

                    hideLoading();
                    console.log("Carte 3D initialisée avec succès");

                    var modeIndicator = document.getElementById('mode-indicator');
                    modeIndicator.style.display = 'block';
                    setTimeout(function () {
                        modeIndicator.style.opacity = '0';
                        setTimeout(function () {
                            modeIndicator.style.display = 'none';
                            modeIndicator.style.opacity = '1';
                        }, 300);
                    }, 3000);
                });

                map3d.on('error', function (e) {
                    console.error('Erreur MapLibre:', e);
                    hideLoading();
                    notifyNative('error', { message: 'Erreur lors du chargement de la carte 3D', source: 'initMap3D' });
                });

                document.getElementById('map3d').style.display = 'block';
                map3dInitialized = true;
                return true;
            } catch (e) {
                console.error("Erreur lors de l'initialisation de la carte 3D:", e);
                hideLoading();
                notifyNative('error', { message: e.message, source: 'initMap3D', line: 0 });
                return false;
            }
        }

        // Fonction pour rafraîchir les marqueurs 3D
        function refreshMarkers3D() {
            if (markers3D && markers3D.length > 0) {
                markers3D.forEach(function (marker) {
                    marker.remove();
                });
                markers3D = [];
            }
            addMarkers3D();
        }

        // Fonction pour créer un élément HTML de marqueur 3D
        function createMarker3DElement(station) {
            var statusClass = 'available';
            if (station.status === 'occupee' || station.status === 'occupée') statusClass = 'occupied';
            if (station.status === 'maintenance') statusClass = 'maintenance';

            var pulseClass = (station.status === 'disponible') ? 'pulse' : '';

            var container = document.createElement('div');
            container.className = 'marker-3d';
            container.setAttribute('data-station-id', station.id);

            var markerElement = document.createElement('div');
            markerElement.className = 'station-marker ' + statusClass + ' ' + pulseClass;

            container.appendChild(markerElement);

            return container;
        }

        // Fonction pour ajouter les marqueurs à la carte 3D
        function addMarkers3D() {
            if (!map3d || !stationData || stationData.length === 0) return;

            console.log("Ajout des marqueurs à la carte 3D...");

            stationData.forEach(function (station) {
                adaptStationProperties(station);

                if (station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng))) {
                    var el = createMarker3DElement(station);

                    var popup = new maplibregl.Popup({
                        offset: [0, -20],
                        closeButton: true,
                        closeOnClick: false,
                        maxWidth: '180px',
                        anchor: 'bottom'
                    }).setHTML(createPopupContent(station));

                    var marker = new maplibregl.Marker({
                        element: el,
                        anchor: 'bottom'
                    })
                        .setLngLat([parseFloat(station.lng), parseFloat(station.lat)])
                        .setPopup(popup)
                        .addTo(map3d);

                    marker.stationId = station.id;
                    markers3D.push(marker);

                    el.addEventListener('click', function () {
                        map3d.flyTo({
                            center: [parseFloat(station.lng), parseFloat(station.lat)],
                            zoom: 17,
                            pitch: 60,
                            bearing: Math.random() * 180 - 90,
                            duration: 1000,
                            essential: true
                        });

                        marker.togglePopup();
                        notifyNative('stationSelected', { id: station.id });
                    });

                    popup.on('open', function () {
                        setTimeout(function () {
                            var navButtons = document.querySelectorAll('.navigation-button');
                            navButtons.forEach(function (button) {
                                button.removeEventListener('click', navigateButtonClickHandler);
                                button.addEventListener('click', navigateButtonClickHandler);
                            });
                        }, 100);
                    });
                }
            });

            console.log(`${markers3D.length} marqueurs ajoutés à la carte 3D`);
        }

        // Fonction pour fermer tous les popups
        function closeAllPopups() {
            if (map) {
                map.closePopup();
                currentOpenPopup = null;
            }

            if (map3d && window.is3DView) {
                markers3D.forEach(function (marker) {
                    if (marker.getPopup().isOpen()) {
                        marker.togglePopup();
                    }
                });
            }
        }

        // Fonction pour créer un marqueur de borne personnalisé
        function createStationMarker(station) {
            console.log(`Création du marqueur pour la station ${station.id} à [${station.lat}, ${station.lng}]`);

            if (!station.lat || !station.lng || isNaN(parseFloat(station.lat)) || isNaN(parseFloat(station.lng))) {
                console.error(`Coordonnées invalides pour la station ${station.id}: [${station.lat}, ${station.lng}]`);
                return null;
            }

            var lat = parseFloat(station.lat);
            var lng = parseFloat(station.lng);

            var statusClass = 'available';
            if (station.status === 'occupee' || station.status === 'occupée') statusClass = 'occupied';
            if (station.status === 'maintenance') statusClass = 'maintenance';

            var pulseClass = (station.status === 'disponible') ? 'pulse' : '';

            var markerHtml = '<div class="station-marker ' + statusClass + ' ' + pulseClass + '"></div>';

            var customIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });

            var marker = L.marker([lat, lng], {
                icon: customIcon,
                riseOnHover: true,
                stationId: station.id
            });

            var popupContent = createPopupContent(station);

            var popup = L.popup({
                closeButton: true,
                autoClose: false,
                className: 'station-popup-container',
                offset: [0, -20],
                autoPan: false,
                keepInView: false,
                maxWidth: 180,
                minWidth: 170
            }).setContent(popupContent);

            popup.stationId = station.id;
            marker.bindPopup(popup);

            marker.on('click', function (e) {
                closeAllPopups();
                activeMarkerId = station.id;
                centerMapAndOpenPopup(this);
                notifyNative('stationSelected', { id: station.id });
                L.DomEvent.stopPropagation(e);
            });

            marker.on('popupopen', function (e) {
                setTimeout(function () {
                    var navButtons = document.querySelectorAll('.navigation-button');
                    navButtons.forEach(function (button) {
                        button.removeEventListener('click', navigateButtonClickHandler);
                        button.addEventListener('click', navigateButtonClickHandler);
                    });
                }, 100);
            });

            marker.on('popupclose', function (e) {
                if (currentOpenPopup === e.popup) {
                    currentOpenPopup = null;
                }

                if (activeMarkerId === station.id) {
                    activeMarkerId = null;
                }
            });

            return marker;
        }

        // Gestionnaire d'événements pour le clic sur le bouton de navigation
        function navigateButtonClickHandler(event) {
            event.preventDefault();
            event.stopPropagation();

            var stationId = this.getAttribute('data-station-id');
            console.log("Bouton Y aller cliqué pour la station:", stationId);

            if (stationId) {
                navigateToStation(parseInt(stationId));
            }
            return false;
        }

        // Fonction pour créer le contenu du popup
        function createPopupContent(station) {
            var statusClass = 'status-available';
            var statusText = 'Disponible';

            if (station.status === 'occupee' || station.status === 'occupée') {
                statusClass = 'status-occupied';
                statusText = 'Occupée';
            } else if (station.status === 'maintenance') {
                statusClass = 'status-maintenance';
                statusText = 'Maintenance';
            }

            var lastUsageText = 'Il y a 2h';
            var lastUsageClass = '';

            if (station.status === 'maintenance') {
                lastUsageText = 'Indisponible';
                lastUsageClass = 'unavailable';
            } else if (station.last_used_at) {
                var lastUsedDate = new Date(station.last_used_at);
                var now = new Date();
                var diffMs = now - lastUsedDate;
                var diffHrs = Math.floor(diffMs / (1000 * 60 * 60));

                if (diffHrs < 24) {
                    lastUsageText = 'Il y a ' + diffHrs + 'h';
                } else {
                    var diffDays = Math.floor(diffHrs / 24);
                    lastUsageText = 'Il y a ' + diffDays + 'j';
                }
            }

            var powerIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l3-8z"/></svg>';
            var navigationIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>';

            var fullAddress = station.address;
            if (station.postal_code && station.city) {
                fullAddress += ', ' + station.postal_code + ' ' + station.city;
            }

            var power = station.power || station.power_output || 0;
            var percentage = station.percentage || station.charge_percentage || 0;

            return '<div class="station-popup">' +
                '<div class="station-popup-header">' +
                '<h3>' + station.name + '</h3>' +
                '<p>' + fullAddress + '</p>' +
                '</div>' +
                '<div class="station-popup-body">' +
                '<div class="power-info">' +
                '<div class="power-icon">' + powerIcon + '</div>' +
                '<div class="power-value">' + power + ' kW</div>' +
                '<div class="power-badge">RAPIDE</div>' +
                '</div>' +
                '<div class="status-label">État actuel</div>' +
                '<div class="status-value ' + statusClass + '">' + statusText + ' (' + percentage + '%)</div>' +
                '<div class="progress-container">' +
                '<div class="progress-fill ' + statusClass.replace('status-', '') + '" style="width: ' + percentage + '%"></div>' +
                '</div>' +
                '<div class="progress-labels">' +
                '<span>0%</span>' +
                '<span>100%</span>' +
                '</div>' +
                '<div class="usage-info">' +
                '<span class="usage-label">Dernière utilisation</span>' +
                '<span class="last-usage ' + lastUsageClass + '">' + lastUsageText + '</span>' +
                '</div>' +
                '<button class="navigation-button" data-station-id="' + station.id + '">' +
                navigationIcon + 'Y aller</button>' +
                '</div>' +
                '</div>';
        }

        // Créer et ajouter les marqueurs à la carte
        async function addMarkersToMap() {
            try {
                if (!map) {
                    console.error("La carte n'est pas initialisée");
                    return false;
                }

                if (!markerLayer) {
                    markerLayer = L.layerGroup().addTo(map);
                } else {
                    markerLayer.clearLayers();
                }

                markers = [];

                if (!stationData || stationData.length === 0) {
                    console.warn("Aucune donnée de station disponible");
                    map.setView([45.899, 6.129], 14);
                    return false;
                }

                console.log("Données des stations:", JSON.stringify(stationData));

                var bounds = L.latLngBounds();
                var validStations = [];

                document.getElementById('loading-indicator').style.display = 'block';

                for (let i = 0; i < stationData.length; i++) {
                    let station = stationData[i];

                    adaptStationProperties(station);

                    if (station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng))) {
                        station.lat = parseFloat(station.lat);
                        station.lng = parseFloat(station.lng);
                        bounds.extend([station.lat, station.lng]);
                        validStations.push(station);
                    } else {
                        console.error("Coordonnées invalides pour la station:", station);
                    }
                }

                document.getElementById('loading-indicator').style.display = 'none';

                validStations.forEach(function (station) {
                    var marker = createStationMarker(station);
                    if (marker) {
                        markers.push(marker);
                        markerLayer.addLayer(marker);
                    }
                });

                if (validStations.length > 0) {
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        animate: true,
                        duration: 1.0,
                        easeLinearity: 0.15
                    });
                    console.log("Carte centrée sur les bornes. Limites:", bounds.toString());
                } else {
                    map.setView([45.899, 6.129], 14);
                    console.warn("Aucune station valide trouvée, centrage sur Annecy");
                }

                console.log("Marqueurs ajoutés à la carte:", markers.length);
                return true;
            } catch (e) {
                console.error("Erreur lors de l'ajout des marqueurs:", e);
                document.getElementById('loading-indicator').style.display = 'none';
                return false;
            }
        }

        // Fonction pour adapter les propriétés des stations selon la structure de la base de données
        function adaptStationProperties(station) {
            if (station.borne_id !== undefined && station.id === undefined) {
                station.id = station.borne_id;
            }

            if (station.latitude !== undefined && station.lat === undefined) {
                station.lat = station.latitude;
            }

            if (station.longitude !== undefined && station.lng === undefined) {
                station.lng = station.longitude;
            }

            if (station.power_output !== undefined && station.power === undefined) {
                station.power = station.power_output;
            }

            if (station.charge_percentage !== undefined && station.percentage === undefined) {
                station.percentage = station.charge_percentage;
            }

            if (station.status !== undefined) {
                station.status = station.status.toLowerCase();
            }

            if (!station.power) station.power = 0;
            if (!station.percentage) station.percentage = 0;
            if (!station.status) station.status = 'disponible';

            return station;
        }

        // Fonction pour mettre à jour les données des bornes
        async function updateStationData(newData) {
            try {
                if (newData && Array.isArray(newData)) {
                    console.log("Mise à jour des données des bornes:", JSON.stringify(newData));
                    lastUpdateTimestamp = Date.now();
                    stationData = newData;

                    document.getElementById('loading-indicator').style.display = 'block';

                    for (let i = 0; i < stationData.length; i++) {
                        let station = stationData[i];

                        adaptStationProperties(station);

                        if (station.lat && station.lng) {
                            station.lat = parseFloat(station.lat);
                            station.lng = parseFloat(station.lng);

                            if (isNaN(station.lat) || isNaN(station.lng)) {
                                console.error(`Coordonnées invalides pour la station ${station.id}: [${station.lat}, ${station.lng}]`);
                            }
                        }
                    }

                    document.getElementById('loading-indicator').style.display = 'none';

                    if (map && markerLayer && !window.is3DView) {
                        var previousActiveId = activeMarkerId;

                        markerLayer.clearLayers();
                        await addMarkersToMap();
                        console.log('Marqueurs mis à jour avec les nouvelles données (2D)');

                        if (previousActiveId !== null) {
                            setTimeout(function () {
                                zoomToStation(previousActiveId);
                            }, 300);
                        }
                    }

                    if (map3d && map3dInitialized && window.is3DView) {
                        refreshMarkers3D();
                        console.log('Marqueurs mis à jour avec les nouvelles données (3D)');
                    }
                }
            } catch (e) {
                console.error("Erreur lors de la mise à jour des données:", e);
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        // Fonction pour afficher l'indicateur de chargement
        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        // Fonction pour masquer l'indicateur de chargement
        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // Fonction pour afficher les filtres
        function showFilters() {
            notifyNative('showFilters', {});
        }

        // Fonction pour centrer sur la position de l'utilisateur
        function centerOnUserLocation() {
            try {
                showLoading();

                if (window.is3DView && map3d) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;

                            map3d.flyTo({
                                center: [lng, lat],
                                zoom: 16,
                                pitch: 60,
                                bearing: 0,
                                duration: 1500
                            });

                            var el = document.createElement('div');
                            el.style.width = '16px';
                            el.style.height = '16px';
                            el.style.borderRadius = '50%';
                            el.style.backgroundColor = '#3388ff';
                            el.style.border = '3px solid white';
                            el.style.boxShadow = '0 0 8px rgba(0,0,0,0.5)';

                            var userMarker = new maplibregl.Marker(el)
                                .setLngLat([lng, lat])
                                .addTo(map3d);

                            setTimeout(function () {
                                userMarker.remove();
                            }, 10000);

                            notifyNative('locationUpdated', { lat: lat, lng: lng });
                            hideLoading();
                        }, function (error) {
                            console.error('Erreur de géolocalisation:', error);
                            alert('Impossible d\'obtenir votre position. Vérifiez que la géolocalisation est activée.');
                            hideLoading();
                        });
                    } else {
                        alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
                        hideLoading();
                    }
                } else if (map) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;

                            map.flyTo([lat, lng], 15, {
                                animate: true,
                                duration: 1.2,
                                easeLinearity: 0.15
                            });

                            var userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    html: '<div style="background-color: #3388ff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.5);"></div>',
                                    className: '',
                                    iconSize: [22, 22],
                                    iconAnchor: [11, 11]
                                })
                            }).addTo(map);

                            var accuracyCircle = L.circle([lat, lng], {
                                radius: position.coords.accuracy || 100,
                                color: '#3388ff',
                                fillColor: '#3388ff',
                                fillOpacity: 0.15,
                                weight: 2
                            }).addTo(map);

                            setTimeout(function () {
                                map.removeLayer(userMarker);
                                map.removeLayer(accuracyCircle);
                            }, 10000);

                            notifyNative('locationUpdated', { lat: lat, lng: lng });
                            hideLoading();
                        }, function (error) {
                            console.error('Erreur de géolocalisation:', error);
                            alert('Impossible d\'obtenir votre position. Vérifiez que la géolocalisation est activée.');
                            hideLoading();
                        }, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    } else {
                        alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
                        hideLoading();
                    }
                } else {
                    console.error("Aucune carte n'est initialisée");
                    hideLoading();
                }
            } catch (e) {
                console.error("Erreur lors de la géolocalisation:", e);
                hideLoading();
            }
        }

        // Fonctions pour le zoom
        function zoomIn() {
            try {
                if (window.is3DView && map3d) {
                    map3d.easeTo({
                        zoom: map3d.getZoom() + 0.5,
                        duration: 300,
                        easing: function (t) {
                            return t * (2 - t);
                        }
                    });
                } else if (map) {
                    map.zoomIn(0.5, {
                        animate: true,
                        duration: 0.3,
                        easeLinearity: 0.15
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du zoom avant:", e);
                return false;
            }
        }

        function zoomOut() {
            try {
                if (window.is3DView && map3d) {
                    map3d.easeTo({
                        zoom: map3d.getZoom() - 0.5,
                        duration: 300,
                        easing: function (t) {
                            return t * (2 - t);
                        }
                    });
                } else if (map) {
                    map.zoomOut(0.5, {
                        animate: true,
                        duration: 0.3,
                        easeLinearity: 0.15
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du zoom arrière:", e);
                return false;
            }
        }

        // Fonction pour basculer entre les vues 2D et 3D
        function toggle3DView() {
            try {
                window.is3DView = !window.is3DView;

                if (window.is3DView) {
                    showLoading();

                    if (!map3dInitialized) {
                        initMap3D();
                    } else {
                        document.getElementById('map3d').style.display = 'block';
                        refreshMarkers3D();

                        var modeIndicator = document.getElementById('mode-indicator');
                        modeIndicator.style.display = 'block';
                        setTimeout(function () {
                            modeIndicator.style.opacity = '0';
                            setTimeout(function () {
                                modeIndicator.style.display = 'none';
                                modeIndicator.style.opacity = '1';
                            }, 300);
                        }, 3000);
                    }

                    document.getElementById('map').style.display = 'none';
                    notifyNative('viewChanged', { mode: '3D' });
                    hideLoading();
                    return true;
                } else {
                    showLoading();
                    document.getElementById('map3d').style.display = 'none';
                    document.getElementById('map').style.display = 'block';

                    if (map) {
                        map.invalidateSize();
                    }

                    notifyNative('viewChanged', { mode: '2D' });
                    hideLoading();
                    return false;
                }
            } catch (e) {
                console.error("Erreur lors du changement de vue:", e);
                hideLoading();
                return false;
            }
        }

        // Fonction pour recentrer la carte
        function centerMap() {
            try {
                if (stationData && stationData.length > 0) {
                    var validStations = stationData.filter(function (station) {
                        return station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng));
                    });

                    if (validStations.length > 0) {
                        if (window.is3DView && map3d) {
                            var bounds = new maplibregl.LngLatBounds();
                            validStations.forEach(function (station) {
                                bounds.extend([parseFloat(station.lng), parseFloat(station.lat)]);
                            });

                            map3d.fitBounds(bounds, {
                                padding: 50,
                                duration: 1500,
                                easing: function (t) {
                                    return t * (2 - t);
                                }
                            });
                        } else if (map) {
                            var bounds = L.latLngBounds();
                            validStations.forEach(function (station) {
                                bounds.extend([parseFloat(station.lat), parseFloat(station.lng)]);
                            });

                            map.flyToBounds(bounds, {
                                padding: [50, 50],
                                animate: true,
                                duration: 1.2,
                                easeLinearity: 0.15
                            });
                        }
                        return true;
                    }
                }

                if (window.is3DView && map3d) {
                    map3d.flyTo({
                        center: [6.129, 45.899],
                        zoom: 14,
                        duration: 1500,
                        easing: function (t) {
                            return t * (2 - t);
                        }
                    });
                } else if (map) {
                    map.flyTo([45.899, 6.129], 14, {
                        animate: true,
                        duration: 1.2,
                        easeLinearity: 0.15
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du recentrage de la carte:", e);
                return false;
            }
        }

        // Fonction pour zoomer sur une station spécifique
        async function zoomToStation(stationId) {
            try {
                console.log("Zoom to station: " + stationId);

                var station = stationData.find(function (s) {
                    return s.id === parseInt(stationId) || s.borne_id === parseInt(stationId);
                });

                if (station) {
                    console.log("Station trouvée pour le zoom:", station);
                    adaptStationProperties(station);
                    activeMarkerId = station.id;

                    if (window.is3DView && map3d) {
                        map3d.flyTo({
                            center: [parseFloat(station.lng), parseFloat(station.lat)],
                            zoom: 17,
                            pitch: 60,
                            bearing: Math.random() * 180 - 90,
                            duration: 1000,
                            essential: true
                        });

                        var marker3D = markers3D.find(function (m) {
                            return m.stationId === parseInt(stationId);
                        });

                        if (marker3D) {
                            setTimeout(function () {
                                marker3D.togglePopup();
                            }, 1000);
                        }
                    } else if (map) {
                        closeAllPopups();

                        var marker = markers.find(function (m) {
                            return m.options.stationId === parseInt(stationId);
                        });

                        if (marker) {
                            // Utiliser le centrage parfait amélioré
                            centerMarkerPerfectly(marker);
                        } else {
                            // Si le marqueur n'est pas trouvé, créer un nouveau marqueur temporaire
                            console.log("Marqueur non trouvé, création d'un marqueur temporaire");
                            var tempMarker = createStationMarker(station);
                            if (tempMarker) {
                                markerLayer.addLayer(tempMarker);
                                markers.push(tempMarker);
                                centerMarkerPerfectly(tempMarker);
                            } else {
                                // Fallback si la création du marqueur échoue
                                map.flyTo([station.lat, station.lng], 17, {
                                    animate: true,
                                    duration: 0.8,
                                    easeLinearity: 0.15
                                });
                            }
                        }
                    }

                    notifyNative('stationSelected', { id: stationId });
                    return true;
                } else {
                    console.error("Station non trouvée avec l'ID:", stationId);
                }

                return false;
            } catch (e) {
                console.error("Erreur lors du zoom sur la station:", e);
                return false;
            }
        }

        // Fonction pour naviguer vers une station
        async function navigateToStation(stationId) {
            try {
                console.log("Navigation vers la station: " + stationId);

                var station = stationData.find(function (s) {
                    return s.id === parseInt(stationId) || s.borne_id === parseInt(stationId);
                });

                if (station) {
                    console.log("Station trouvée pour la navigation:", station);
                    adaptStationProperties(station);

                    var fullAddress = station.address || "";
                    if (station.postal_code && station.city) {
                        fullAddress += ', ' + station.postal_code + ' ' + station.city;
                    }

                    var lat = parseFloat(station.lat);
                    var lng = parseFloat(station.lng);

                    var googleMapsUrl = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
                    var appleMapsUrl = "maps://?daddr=" + lat + "," + lng + "&dirflg=d";

                    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    var navigationUrl = isIOS ? appleMapsUrl : googleMapsUrl;

                    var linkElement = document.createElement('a');
                    linkElement.href = navigationUrl;
                    linkElement.target = '_blank';
                    linkElement.click();

                    notifyNative('navigate', {
                        id: stationId,
                        address: fullAddress,
                        lat: lat,
                        lng: lng,
                        url: navigationUrl
                    });

                    return true;
                } else {
                    console.error("Station non trouvée avec l'ID:", stationId);
                }

                return false;
            } catch (e) {
                console.error("Erreur lors de la navigation vers la station:", e);
                return false;
            }
        }

        // Fonction pour communiquer avec l'application native
        function notifyNative(action, data) {
            try {
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.jsBridge) {
                    window.webkit.messageHandlers.jsBridge.postMessage({
                        action: action,
                        data: data
                    });
                } else if (window.jsBridge) {
                    window.jsBridge.receiveMessage(JSON.stringify({
                        action: action,
                        data: data
                    }));
                } else {
                    console.log("Communication bridge not found");
                }
            } catch (e) {
                console.error("Error notifying native app:", e);
            }
        }

        // Ajouter un gestionnaire d'erreurs
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('Erreur JavaScript:', message, 'à', source, ':', lineno);
            notifyNative('error', { message: message, source: source, line: lineno });
            return true;
        };

        // Exposer les fonctions pour l'interface native
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.toggle3DView = toggle3DView;
        window.centerMap = centerMap;
        window.centerOnUserLocation = centerOnUserLocation;
        window.zoomToStation = zoomToStation;
        window.initMap = initMap;
        window.showFilters = showFilters;
        window.navigateToStation = navigateToStation;
        window.updateStationData = updateStationData;
        window.closeAllPopups = closeAllPopups;

        // Nouvelles fonctions pour la mise à jour en temps réel
        window.handleRealTimeUpdate = handleRealTimeUpdate;
        window.startRealTimeUpdates = startRealTimeUpdates;
        window.stopRealTimeUpdates = stopRealTimeUpdates;

        // Initialiser la carte quand le DOM est chargé
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM chargé, initialisation de la carte");
            setTimeout(initMap, 500);
        });

        // Nettoyer les intervalles quand la page se ferme
        window.addEventListener('beforeunload', function () {
            stopRealTimeUpdates();
        });
    </script>
</body>
</html>