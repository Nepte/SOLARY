<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Carte des bornes</title>
    <style>
        html, body, #map, #map3d {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overscroll-behavior: none;
            touch-action: manipulation;
            position: fixed;
            overflow: hidden;
        }

        /* Style pour les marqueurs de bornes */
        .station-marker {
            width: 36px;
            height: 36px;
            background-color: #FFD602;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            will-change: transform;
        }

            .station-marker::after {
                content: '';
                width: 24px;
                height: 24px;
                background-color: white;
                border-radius: 50%;
                transform: rotate(45deg);
                box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
            }

            .station-marker:hover {
                transform: rotate(-45deg) scale(1.1);
                box-shadow: 0 5px 12px rgba(0,0,0,0.5);
            }

            .station-marker.available {
                background-color: #4CAF50; /* Vert pour disponible */
            }

            .station-marker.occupied {
                background-color: #FFD602; /* Jaune pour occupé */
            }

            .station-marker.maintenance {
                background-color: #F44336; /* Rouge pour maintenance */
            }

        /* Style pour les marqueurs 3D */
        .marker-3d {
            width: 36px;
            height: 36px;
            cursor: pointer;
            position: relative;
        }

            .marker-3d .station-marker {
                position: absolute;
                top: 0;
                left: 0;
                width: 36px;
                height: 36px;
            }

        /* Style pour les popups */
        .leaflet-popup-content-wrapper {
            padding: 0;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: none;
            background: transparent;
        }

        .leaflet-popup-content {
            margin: 0;
            padding: 0;
            width: 200px !important;
            background: transparent;
        }

        .leaflet-popup-tip {
            background-color: white;
        }

        .leaflet-popup-close-button {
            color: rgba(255,255,255,0.9) !important;
            margin: 4px 4px 0 0 !important;
            font-size: 14px !important;
            font-weight: 300 !important;
            width: 18px !important;
            height: 18px !important;
            background: rgba(0,0,0,0.2) !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 10 !important;
        }

            .leaflet-popup-close-button:hover {
                color: white !important;
                background: rgba(0,0,0,0.4) !important;
            }

        .station-popup {
            width: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            border-radius: 10px;
            overflow: hidden;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .station-popup-header {
            padding: 10px;
            position: relative;
            z-index: 1;
        }

            .station-popup-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(255,214,2,0.15) 0%, rgba(255,214,2,0.05) 100%);
                z-index: -1;
            }

            .station-popup-header h3 {
                margin: 0 0 5px 0;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: -0.2px;
                color: white;
            }

            .station-popup-header p {
                margin: 0;
                font-size: 12px;
                color: rgba(255,255,255,0.7);
                font-weight: 400;
            }

        .station-popup-body {
            padding: 10px;
            background-color: white;
            color: #333333;
            border-radius: 0 0 10px 10px;
        }

        .power-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        .power-icon {
            width: 32px;
            height: 32px;
            background-color: #FFD602;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            box-shadow: 0 2px 6px rgba(255,214,2,0.3);
        }

            .power-icon svg {
                width: 18px;
                height: 18px;
                fill: #1a1a1a;
            }

        .power-details {
            flex: 1;
        }

        .power-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .power-type {
            font-size: 12px;
            color: #666;
        }

        .power-badge {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f0f0f0;
            color: #1a1a1a;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .status-container {
            margin: 15px 0;
            position: relative;
        }

        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-available {
            color: #4CAF50;
        }

        .status-occupied {
            color: #FFD602;
        }

        .status-maintenance {
            color: #F44336;
        }

        .progress-container {
            height: 6px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

            .progress-fill.available {
                background: linear-gradient(90deg, #4CAF50, #8BC34A);
            }

            .progress-fill.occupied {
                background: linear-gradient(90deg, #FFD602, #FFC107);
            }

            .progress-fill.maintenance {
                background: linear-gradient(90deg, #F44336, #FF5722);
            }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #999;
        }

        .usage-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .usage-label {
            color: #666;
            font-size: 12px;
        }

        .last-usage {
            display: inline-block;
            background-color: #1a1a1a;
            color: white;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 12px;
        }

            .last-usage.unavailable {
                background-color: #f0f0f0;
                color: #666;
            }

        /* Attribution de la carte */
        .leaflet-control-attribution {
            font-size: 9px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Indicateur de chargement */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            display: none;
        }

        /* Animation de pulsation pour les marqueurs */
        @keyframes pulse {
            0% {
                transform: rotate(-45deg) scale(1);
            }

            50% {
                transform: rotate(-45deg) scale(1.1);
            }

            100% {
                transform: rotate(-45deg) scale(1);
            }
        }

        .station-marker.pulse {
            animation: pulse 1.5s infinite;
        }

        /* Style pour le bouton de navigation */
        .navigation-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1a1a1a;
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 10px 15px;
            border-radius: 20px;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            width: 100%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

            .navigation-button:hover {
                background-color: #333;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            .navigation-button svg {
                width: 16px;
                height: 16px;
                margin-right: 6px;
                fill: currentColor;
            }

        /* Amélioration de la fluidité des animations */
        .leaflet-fade-anim .leaflet-tile,
        .leaflet-fade-anim .leaflet-popup {
            will-change: opacity;
            backface-visibility: hidden;
        }

        .leaflet-zoom-anim .leaflet-zoom-animated {
            will-change: transform;
            backface-visibility: hidden;
            transform-style: preserve-3d;
        }

        /* Optimisations pour le défilement */
        .leaflet-container {
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
        }

        /* Style pour le mode 3D */
        .maplibregl-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Contrôles 3D */
        .maplibregl-ctrl-top-right {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .maplibregl-ctrl-group {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .maplibregl-ctrl button {
            width: 30px;
            height: 30px;
            display: block;
            padding: 0;
            outline: none;
            border: 0;
            box-sizing: border-box;
            background-color: transparent;
            cursor: pointer;
        }

        /* Indicateur de mode 3D */
        .mode-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: none;
            transition: opacity 0.3s ease;
        }

        /* Amélioration pour les popups */
        .leaflet-popup {
            margin-bottom: 0 !important; /* Correction: Suppression du décalage vertical du popup */
        }

        /* Style pour les marqueurs 3D */
        .maplibregl-marker {
            will-change: transform;
        }

        /* Style pour les popups 3D */
        .maplibregl-popup {
            z-index: 1;
        }

        .maplibregl-popup-content {
            padding: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .maplibregl-popup-close-button {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 300;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px 4px 0 0;
            padding: 0;
            border: none;
            cursor: pointer;
        }

            .maplibregl-popup-close-button:hover {
                color: white;
                background: rgba(0,0,0,0.4);
            }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MapLibre GL JS pour la vue 3D -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
</head>
<body>
    <div id="map"></div>
    <div id="map3d" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>

    <!-- Indicateur de chargement -->
    <div class="loading-indicator" id="loading-indicator">Chargement...</div>

    <!-- Indicateur de mode -->
    <div class="mode-indicator" id="mode-indicator">Mode 3D activé</div>

    <!-- Load Leaflet from CDN -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- MapLibre GL JS pour la vue 3D -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <script>
        // Initialiser la carte avec un style standard
        var map = null;
        var map3d = null;

        // Données des bornes - sera remplacé par les données réelles de l'API
        var stationData = [];

        // Variable pour la vue 3D
        window.is3DView = false;

        // Variable pour stocker le popup actuellement ouvert
        var currentOpenPopup = null;

        // Variable pour éviter les animations multiples
        var isAnimating = false;

        // Variable pour suivre si la carte est initialisée
        var mapInitialized = false;
        var map3dInitialized = false;

        // Variables pour les marqueurs 3D
        var markers3D = [];

        // Fonction pour initialiser la carte
        function initMap() {
            try {
                console.log("Initialisation de la carte...");

                // Créer l'instance de la carte avec des options pour améliorer la fluidité
                map = L.map('map', {
                    zoomControl: false,
                    attributionControl: true,
                    minZoom: 5,
                    maxZoom: 19,
                    zoomSnap: 0.1,  // Valeur plus petite pour un zoom plus fluide
                    zoomDelta: 0.1, // Valeur plus petite pour un zoom plus fluide
                    wheelPxPerZoomLevel: 150, // Augmenté pour un défilement plus doux
                    fadeAnimation: true,
                    markerZoomAnimation: true,
                    inertia: true,
                    inertiaDeceleration: 2000, // Réduit pour une inertie plus douce
                    easeLinearity: 0.15, // Réduit pour des animations plus douces
                    worldCopyJump: true,
                    preferCanvas: true,
                    tap: true,
                    bounceAtZoomLimits: false,
                    renderer: L.canvas({ padding: 0.5 })
                });

                console.log("Carte créée");

                // Ajouter la couche de tuiles OpenStreetMap standard
                var standardTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    maxNativeZoom: 19,
                    tileSize: 256,
                    updateWhenIdle: false, // Changé pour une mise à jour continue
                    updateWhenZooming: true, // Changé pour une mise à jour pendant le zoom
                    keepBuffer: 8 // Augmenté pour un défilement plus fluide
                }).addTo(map);

                console.log("Couche de tuiles ajoutée");

                // Ajouter les marqueurs initiaux et centrer la carte
                addMarkersToMap();

                // Notifier que la carte est prête
                notifyNative('mapReady', {});

                console.log("Carte initialisée avec succès");

                // Forcer un rafraîchissement de la carte
                setTimeout(function () {
                    if (map) {
                        map.invalidateSize();
                        console.log("Taille de la carte rafraîchie");
                    }
                }, 500);

                // Ajouter un écouteur d'événement pour le zoom
                map.on('zoomend', function () {
                    if (currentOpenPopup) {
                        // Réajuster la position du popup après le zoom
                        setTimeout(function () {
                            adjustPopupPosition(currentOpenPopup);
                        }, 100);
                    }
                });

                // Ajouter un écouteur d'événement pour fermer les popups lors d'un clic sur la carte
                map.on('click', function () {
                    closeAllPopups();
                });

                // Désactiver le déplacement automatique de la carte lors de l'ouverture d'un popup
                map.on('popupopen', function (e) {
                    // Ajuster la position du popup immédiatement après l'ouverture
                    setTimeout(function () {
                        adjustPopupPosition(e.popup);
                    }, 10);
                });

                // Optimiser le défilement sur les appareils mobiles
                if (L.Browser.touch) {
                    L.DomEvent.disableClickPropagation(document.getElementById('map'));
                    L.DomEvent.disableScrollPropagation(document.getElementById('map'));
                }

                mapInitialized = true;
                return true;
            } catch (e) {
                console.error("Erreur lors de l'initialisation de la carte:", e);
                notifyNative('error', { message: e.message, source: 'initMap', line: 0 });
                return false;
            }
        }

        // Fonction pour initialiser la carte 3D
        function initMap3D() {
            try {
                if (map3dInitialized && map3d) {
                    document.getElementById('map3d').style.display = 'block';
                    // Assurez-vous que les marqueurs sont visibles
                    refreshMarkers3D();
                    return true;
                }

                console.log("Initialisation de la carte 3D...");
                showLoading();

                // Créer l'instance de la carte 3D avec MapLibre GL
                maplibregl.setRTLTextPlugin(
                    'https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js',
                    null,
                    true
                );

                // Obtenir le centre et le zoom actuels de la carte 2D
                var center = [6.129, 45.899]; // Annecy par défaut
                var zoom = 14;

                if (map && mapInitialized) {
                    var mapCenter = map.getCenter();
                    center = [mapCenter.lng, mapCenter.lat];
                    zoom = map.getZoom();
                }

                // Initialiser la carte 3D
                map3d = new maplibregl.Map({
                    container: 'map3d',
                    style: 'https://api.maptiler.com/maps/streets/style.json?key=tsPaLJ6DWZPxMNaJ2DV7',
                    center: center,
                    zoom: zoom,
                    pitch: 45, // Inclinaison pour l'effet 3D
                    bearing: 0,
                    antialias: true,
                    attributionControl: false,
                    renderWorldCopies: true,
                    maxPitch: 85,
                    minPitch: 0,
                    maxZoom: 22,
                    minZoom: 0,
                    dragRotate: true,
                    touchZoomRotate: true,
                    touchPitch: true,
                    cooperativeGestures: false,
                    fadeDuration: 300,
                    optimizeForTerrain: true
                });

                // Ajouter les contrôles de navigation
                map3d.addControl(new maplibregl.NavigationControl({
                    showCompass: true,
                    showZoom: true,
                    visualizePitch: true
                }));

                // Ajouter un contrôle pour réinitialiser la vue
                map3d.addControl(new maplibregl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true,
                    showAccuracyCircle: true,
                    showUserLocation: true
                }));

                // Ajouter la couche 3D des bâtiments lorsque la carte est chargée
                map3d.on('load', function () {
                    // Ajouter une source pour les bâtiments 3D
                    map3d.addSource('openmaptiles', {
                        type: 'vector',
                        url: 'https://api.maptiler.com/tiles/v3/tiles.json?key=tsPaLJ6DWZPxMNaJ2DV7'
                    });

                    // Ajouter la couche des bâtiments 3D
                    map3d.addLayer({
                        'id': 'building-3d',
                        'source': 'openmaptiles',
                        'source-layer': 'building',
                        'type': 'fill-extrusion',
                        'minzoom': 14,
                        'paint': {
                            'fill-extrusion-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'height'],
                                0, '#CCCCCC',
                                50, '#999999',
                                100, '#666666'
                            ],
                            'fill-extrusion-height': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 0,
                                16, ['*', ['get', 'height', 10], 1.2] // Multiplier par 1.2 pour exagérer légèrement la hauteur
                            ],
                            'fill-extrusion-base': 0,
                            'fill-extrusion-opacity': 0.8
                        }
                    });

                    // Ajouter une couche pour les routes en 3D
                    map3d.addLayer({
                        'id': 'road-3d',
                        'source': 'openmaptiles',
                        'source-layer': 'transportation',
                        'type': 'line',
                        'minzoom': 14,
                        'paint': {
                            'line-width': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                14, 1,
                                18, 12
                            ],
                            'line-color': '#ffffff',
                            'line-opacity': 0.8
                        }
                    });

                    // Ajouter les marqueurs des bornes à la carte 3D
                    addMarkers3D();

                    hideLoading();
                    console.log("Carte 3D initialisée avec succès");

                    // Afficher l'indicateur de mode 3D
                    var modeIndicator = document.getElementById('mode-indicator');
                    modeIndicator.style.display = 'block';
                    setTimeout(function () {
                        modeIndicator.style.opacity = '0';
                        setTimeout(function () {
                            modeIndicator.style.display = 'none';
                            modeIndicator.style.opacity = '1';
                        }, 300);
                    }, 3000);
                });

                // Gérer les erreurs
                map3d.on('error', function (e) {
                    console.error('Erreur MapLibre:', e);
                    hideLoading();
                    notifyNative('error', { message: 'Erreur lors du chargement de la carte 3D', source: 'initMap3D' });
                });

                document.getElementById('map3d').style.display = 'block';
                map3dInitialized = true;
                return true;
            } catch (e) {
                console.error("Erreur lors de l'initialisation de la carte 3D:", e);
                hideLoading();
                notifyNative('error', { message: e.message, source: 'initMap3D', line: 0 });
                return false;
            }
        }

        // Fonction pour rafraîchir les marqueurs 3D
        function refreshMarkers3D() {
            // Supprimer tous les marqueurs existants
            if (markers3D && markers3D.length > 0) {
                markers3D.forEach(function (marker) {
                    marker.remove();
                });
                markers3D = [];
            }

            // Ajouter les nouveaux marqueurs
            addMarkers3D();
        }

        // Fonction pour créer un élément HTML de marqueur 3D
        function createMarker3DElement(station) {
            // Déterminer la classe CSS en fonction du statut
            var statusClass = 'available';
            if (station.status === 'occupee' || station.status === 'occupée') statusClass = 'occupied';
            if (station.status === 'maintenance') statusClass = 'maintenance';

            // Ajouter une classe de pulsation pour les stations disponibles
            var pulseClass = (station.status === 'disponible') ? 'pulse' : '';

            // Créer un conteneur pour le marqueur
            var container = document.createElement('div');
            container.className = 'marker-3d';
            container.setAttribute('data-station-id', station.id);

            // Créer l'élément du marqueur avec le même style que les marqueurs 2D
            var markerElement = document.createElement('div');
            markerElement.className = 'station-marker ' + statusClass + ' ' + pulseClass;

            // Ajouter le marqueur au conteneur
            container.appendChild(markerElement);

            return container;
        }

        // Fonction pour ajouter les marqueurs à la carte 3D
        function addMarkers3D() {
            if (!map3d || !stationData || stationData.length === 0) return;

            console.log("Ajout des marqueurs à la carte 3D...");

            // Parcourir les données des stations
            stationData.forEach(function (station) {
                // Adapter les propriétés de la station
                adaptStationProperties(station);

                if (station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng))) {
                    // Créer un élément HTML pour le marqueur avec le même style que les marqueurs 2D
                    var el = createMarker3DElement(station);

                    // Créer un popup pour le marqueur
                    var popup = new maplibregl.Popup({
                        offset: [0, -20],
                        closeButton: true,
                        closeOnClick: false,
                        maxWidth: '300px',
                        anchor: 'bottom'
                    }).setHTML(createPopupContent(station));

                    // Ajouter le marqueur à la carte
                    var marker = new maplibregl.Marker({
                        element: el,
                        anchor: 'bottom'
                    })
                        .setLngLat([parseFloat(station.lng), parseFloat(station.lat)])
                        .setPopup(popup)
                        .addTo(map3d);

                    // Stocker l'ID de la station dans le marqueur
                    marker.stationId = station.id;

                    // Ajouter le marqueur à la liste des marqueurs 3D
                    markers3D.push(marker);

                    // Ajouter un écouteur d'événement pour le clic sur le marqueur
                    el.addEventListener('click', function () {
                        // Centrer la carte sur le marqueur
                        map3d.flyTo({
                            center: [parseFloat(station.lng), parseFloat(station.lat)],
                            zoom: 17,
                            pitch: 60,
                            bearing: Math.random() * 180 - 90, // Rotation aléatoire pour un effet dynamique
                            duration: 1000,
                            essential: true
                        });

                        // Ouvrir le popup
                        marker.togglePopup();

                        // Notifier l'application native
                        notifyNative('stationSelected', { id: station.id });
                    });

                    // Ajouter des gestionnaires d'événements pour les boutons dans le popup
                    popup.on('open', function () {
                        setTimeout(function () {
                            var navButtons = document.querySelectorAll('.navigation-button');
                            navButtons.forEach(function (button) {
                                button.removeEventListener('click', navigateButtonClickHandler);
                                button.addEventListener('click', navigateButtonClickHandler);
                            });
                        }, 100);
                    });
                }
            });

            console.log(`${markers3D.length} marqueurs ajoutés à la carte 3D`);
        }

        // Fonction pour fermer tous les popups
        function closeAllPopups() {
            if (map) {
                map.closePopup();
                currentOpenPopup = null;
            }

            if (map3d && window.is3DView) {
                // Fermer tous les popups dans la vue 3D
                markers3D.forEach(function (marker) {
                    if (marker.getPopup().isOpen()) {
                        marker.togglePopup();
                    }
                });
            }
        }

        // Fonction pour ajuster la position d'un popup
        function adjustPopupPosition(popup) {
            if (!map || !popup) return;

            // Ne pas ajuster la position si une animation est en cours
            if (isAnimating) return;

            // Obtenir la position actuelle du popup
            var popupLatLng = popup.getLatLng();

            // Calculer la position idéale pour le popup
            var popupHeight = 300; // Hauteur estimée du popup en pixels
            var mapHeight = map.getSize().y;
            var popupPoint = map.latLngToContainerPoint(popupLatLng);

            // Si le popup est trop bas dans la vue, le déplacer vers le haut
            if (popupPoint.y > mapHeight - popupHeight) {
                var newY = Math.max(popupHeight, mapHeight - popupHeight);
                var newPoint = L.point(popupPoint.x, newY);
                var newLatLng = map.containerPointToLatLng(newPoint);
                popup.setLatLng(newLatLng);
            }
        }

        // Variables globales pour les marqueurs
        var markers = [];
        var markerLayer = null;
        var activeMarkerId = null;

        // Fonction pour créer un marqueur de borne personnalisé
        function createStationMarker(station) {
            // Vérifier et afficher les coordonnées pour le débogage
            console.log(`Création du marqueur pour la station ${station.id} à [${station.lat}, ${station.lng}]`);

            // Vérifier si les coordonnées sont valides
            if (!station.lat || !station.lng || isNaN(parseFloat(station.lat)) || isNaN(parseFloat(station.lng))) {
                console.error(`Coordonnées invalides pour la station ${station.id}: [${station.lat}, ${station.lng}]`);
                return null;
            }

            // Convertir explicitement en nombres flottants
            var lat = parseFloat(station.lat);
            var lng = parseFloat(station.lng);

            // Déterminer la classe CSS en fonction du statut
            var statusClass = 'available';
            if (station.status === 'occupee' || station.status === 'occupée') statusClass = 'occupied';
            if (station.status === 'maintenance') statusClass = 'maintenance';

            // Ajouter une classe de pulsation pour les stations disponibles
            var pulseClass = (station.status === 'disponible') ? 'pulse' : '';

            // Créer l'élément HTML du marqueur
            var markerHtml = '<div class="station-marker ' + statusClass + ' ' + pulseClass + '"></div>';

            // Créer l'icône personnalisée
            var customIcon = L.divIcon({
                html: markerHtml,
                className: '',
                iconSize: [36, 36],
                iconAnchor: [18, 36]
            });

            // Créer le marqueur avec l'icône personnalisée
            var marker = L.marker([lat, lng], {
                icon: customIcon,
                riseOnHover: true,
                stationId: station.id // Stocker l'ID de la station directement dans les options du marqueur
            });

            // Créer le contenu du popup
            var popupContent = createPopupContent(station);

            // Ajouter un popup au marqueur avec des options spécifiques
            var popup = L.popup({
                closeButton: true,
                autoClose: false,
                className: 'station-popup-container',
                offset: [0, -20],
                autoPan: false, // Désactiver le centrage automatique
                keepInView: true
            }).setContent(popupContent);

            // Stocker l'ID de la station dans le popup
            popup.stationId = station.id;

            marker.bindPopup(popup);

            // Ajouter un écouteur d'événement pour le clic sur le marqueur
            marker.on('click', function (e) {
                // Fermer tous les autres popups
                closeAllPopups();

                // Stocker l'ID du marqueur actif
                activeMarkerId = station.id;

                // Centrer immédiatement la carte sur le marqueur et ouvrir le popup
                // Correction: Centrer et ouvrir le popup en une seule fois
                centerMapAndOpenPopup(this);

                // Notifier l'application native
                notifyNative('stationSelected', { id: station.id });

                // Empêcher la propagation de l'événement
                L.DomEvent.stopPropagation(e);
            });

            // Ajouter un écouteur d'événement pour l'ouverture du popup
            marker.on('popupopen', function (e) {
                // Ajouter des gestionnaires d'événements pour les boutons dans le popup
                setTimeout(function () {
                    var navButtons = document.querySelectorAll('.navigation-button');
                    navButtons.forEach(function (button) {
                        // Supprimer les gestionnaires d'événements existants pour éviter les doublons
                        button.removeEventListener('click', navigateButtonClickHandler);
                        // Ajouter le nouveau gestionnaire d'événements
                        button.addEventListener('click', navigateButtonClickHandler);
                    });
                }, 100);
            });

            // Ajouter un écouteur d'événement pour la fermeture du popup
            marker.on('popupclose', function (e) {
                if (currentOpenPopup === e.popup) {
                    currentOpenPopup = null;
                }

                if (activeMarkerId === station.id) {
                    activeMarkerId = null;
                }
            });

            return marker;
        }

        // Fonction pour centrer la carte sur un marqueur et ouvrir son popup
        function centerMapAndOpenPopup(marker) {
            if (!map || !marker) return;

            // Marquer comme en cours d'animation pour éviter les conflits
            isAnimating = true;

            // Obtenir la position du marqueur
            var markerLatLng = marker.getLatLng();

            // Calculer un décalage vers le haut pour que le popup soit bien visible
            var containerPoint = map.latLngToContainerPoint(markerLatLng);
            // Correction: Réduire le décalage vertical pour que le popup reste près du marqueur
            containerPoint.y -= 50;
            var targetLatLng = map.containerPointToLatLng(containerPoint);

            // Animer le déplacement de la carte
            map.flyTo(targetLatLng, 16, {
                animate: true,
                duration: 0.5, // Durée réduite pour une réponse plus rapide
                easeLinearity: 0.15,
                noMoveStart: true
            });

            // Ouvrir le popup immédiatement
            marker.openPopup();
            currentOpenPopup = marker.getPopup();

            // Réinitialiser le flag d'animation après la fin de l'animation
            setTimeout(function () {
                isAnimating = false;
                // Correction: Ajuster la position du popup après l'animation
                if (currentOpenPopup) {
                    adjustPopupPosition(currentOpenPopup);
                }
            }, 600);
        }

        // Gestionnaire d'événements pour le clic sur le bouton de navigation
        function navigateButtonClickHandler(event) {
            event.preventDefault();
            event.stopPropagation();

            // Extraire l'ID de la station à partir de l'attribut data-station-id
            var stationId = this.getAttribute('data-station-id');
            console.log("Bouton Y aller cliqué pour la station:", stationId);

            if (stationId) {
                navigateToStation(parseInt(stationId));
            }
            return false;
        }

        // Fonction pour créer le contenu du popup
        function createPopupContent(station) {
            // Déterminer la classe CSS en fonction du statut
            var statusClass = 'status-available';
            var statusText = 'Disponible';

            if (station.status === 'occupee' || station.status === 'occupée') {
                statusClass = 'status-occupied';
                statusText = 'Occupée';
            } else if (station.status === 'maintenance') {
                statusClass = 'status-maintenance';
                statusText = 'Maintenance';
            }

            // Déterminer le texte de la dernière utilisation
            var lastUsageText = 'Il y a 2h';
            var lastUsageClass = '';

            if (station.status === 'maintenance') {
                lastUsageText = 'Indisponible';
                lastUsageClass = 'unavailable';
            } else if (station.last_used_at) {
                // Formater la date de dernière utilisation si disponible
                var lastUsedDate = new Date(station.last_used_at);
                var now = new Date();
                var diffMs = now - lastUsedDate;
                var diffHrs = Math.floor(diffMs / (1000 * 60 * 60));

                if (diffHrs < 24) {
                    lastUsageText = 'Il y a ' + diffHrs + 'h';
                } else {
                    var diffDays = Math.floor(diffHrs / 24);
                    lastUsageText = 'Il y a ' + diffDays + 'j';
                }
            }

            // Icône pour la puissance (SVG inline)
            var powerIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l3-8z"/></svg>';

            // Icône GPS pour le bouton de navigation
            var navigationIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>';

            // Construire l'adresse complète
            var fullAddress = station.address;
            if (station.postal_code && station.city) {
                fullAddress += ', ' + station.postal_code + ' ' + station.city;
            }

            // Déterminer la puissance à afficher
            var power = station.power || station.power_output || 0;

            // Déterminer le pourcentage de charge
            var percentage = station.percentage || station.charge_percentage || 0;

            return '<div class="station-popup">' +
                '<div class="station-popup-header">' +
                '<h3>' + station.name + '</h3>' +
                '<p>' + fullAddress + '</p>' +
                '</div>' +
                '<div class="station-popup-body">' +
                '<div class="power-info">' +
                '<div class="power-icon">' + powerIcon + '</div>' +
                '<div class="power-details">' +
                '<div class="power-value">' + power + ' kW</div>' +
                '<div class="power-type">Puissance</div>' +
                '</div>' +
                '<div class="power-badge">Rapide</div>' +
                '</div>' +
                '<div class="status-container">' +
                '<div class="status-label">État actuel</div>' +
                '<div class="status-value ' + statusClass + '">' + statusText + ' (' + percentage + '%)</div>' +
                '<div class="progress-container">' +
                '<div class="progress-fill ' + statusClass.replace('status-', '') + '" style="width: ' + percentage + '%"></div>' +
                '</div>' +
                '<div class="progress-labels">' +
                '<span>0%</span>' +
                '<span>100%</span>' +
                '</div>' +
                '</div>' +
                '<div class="usage-info">' +
                '<span class="usage-label">Dernière utilisation</span>' +
                '<span class="last-usage ' + lastUsageClass + '">' + lastUsageText + '</span>' +
                '</div>' +
                '<button class="navigation-button" data-station-id="' + station.id + '">' +
                navigationIcon + 'Y aller</button>' +
                '</div>' +
                '</div>';
        }

        // Créer et ajouter les marqueurs à la carte
        async function addMarkersToMap() {
            try {
                if (!map) {
                    console.error("La carte n'est pas initialisée");
                    return false;
                }

                // Créer la couche de marqueurs si elle n'existe pas
                if (!markerLayer) {
                    markerLayer = L.layerGroup().addTo(map);
                } else {
                    // Vider la couche de marqueurs
                    markerLayer.clearLayers();
                }

                markers = [];

                // Vérifier si stationData est défini et non vide
                if (!stationData || stationData.length === 0) {
                    console.warn("Aucune donnée de station disponible");
                    // Centrer sur une position par défaut si aucune station
                    map.setView([45.899, 6.129], 14); // Annecy par défaut
                    return false;
                }

                console.log("Données des stations:", JSON.stringify(stationData));

                // Calculer les limites pour centrer la carte
                var bounds = L.latLngBounds();
                var validStations = [];

                // Afficher l'indicateur de chargement
                document.getElementById('loading-indicator').style.display = 'block';

                // Traiter chaque station
                for (let i = 0; i < stationData.length; i++) {
                    let station = stationData[i];

                    // Adapter les noms de propriétés selon la structure de la base de données
                    adaptStationProperties(station);

                    if (station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng))) {
                        // Convertir explicitement en nombres flottants
                        station.lat = parseFloat(station.lat);
                        station.lng = parseFloat(station.lng);
                        bounds.extend([station.lat, station.lng]);
                        validStations.push(station);
                    } else {
                        console.error("Coordonnées invalides pour la station:", station);
                    }
                }

                // Masquer l'indicateur de chargement
                document.getElementById('loading-indicator').style.display = 'none';

                // Ajouter les nouveaux marqueurs pour les stations valides
                validStations.forEach(function (station) {
                    var marker = createStationMarker(station);
                    if (marker) {
                        markers.push(marker);
                        markerLayer.addLayer(marker);
                    }
                });

                // Centrer la carte sur les marqueurs si nous avons des stations valides
                if (validStations.length > 0) {
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        animate: true,
                        duration: 1.0, // Durée plus longue pour une animation plus fluide
                        easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                    });
                    console.log("Carte centrée sur les bornes. Limites:", bounds.toString());
                } else {
                    // Centrer sur une position par défaut si aucune station valide
                    map.setView([45.899, 6.129], 14); // Annecy par défaut
                    console.warn("Aucune station valide trouvée, centrage sur Annecy");
                }

                console.log("Marqueurs ajoutés à la carte:", markers.length);
                return true;
            } catch (e) {
                console.error("Erreur lors de l'ajout des marqueurs:", e);
                document.getElementById('loading-indicator').style.display = 'none';
                return false;
            }
        }

        // Fonction pour adapter les propriétés des stations selon la structure de la base de données
        function adaptStationProperties(station) {
            // Adapter les noms de propriétés si nécessaire
            if (station.borne_id !== undefined && station.id === undefined) {
                station.id = station.borne_id;
            }

            if (station.latitude !== undefined && station.lat === undefined) {
                station.lat = station.latitude;
            }

            if (station.longitude !== undefined && station.lng === undefined) {
                station.lng = station.longitude;
            }

            if (station.power_output !== undefined && station.power === undefined) {
                station.power = station.power_output;
            }

            if (station.charge_percentage !== undefined && station.percentage === undefined) {
                station.percentage = station.charge_percentage;
            }

            // Adapter le statut
            if (station.status !== undefined) {
                station.status = station.status.toLowerCase();
            }

            // S'assurer que les valeurs par défaut sont définies
            if (!station.power) station.power = 0;
            if (!station.percentage) station.percentage = 0;
            if (!station.status) station.status = 'disponible';

            return station;
        }

        // Fonction pour mettre à jour les données des bornes
        async function updateStationData(newData) {
            try {
                if (newData && Array.isArray(newData)) {
                    console.log("Mise à jour des données des bornes:", JSON.stringify(newData));
                    stationData = newData;

                    // Afficher l'indicateur de chargement
                    document.getElementById('loading-indicator').style.display = 'block';

                    // Adapter les propriétés de chaque station
                    for (let i = 0; i < stationData.length; i++) {
                        let station = stationData[i];

                        // Adapter les propriétés de la station
                        adaptStationProperties(station);

                        if (station.lat && station.lng) {
                            // Convertir explicitement en nombres flottants
                            station.lat = parseFloat(station.lat);
                            station.lng = parseFloat(station.lng);

                            // Vérifier si les coordonnées sont valides
                            if (isNaN(station.lat) || isNaN(station.lng)) {
                                console.error(`Coordonnées invalides pour la station ${station.id}: [${station.lat}, ${station.lng}]`);
                            }
                        }
                    }

                    // Masquer l'indicateur de chargement
                    document.getElementById('loading-indicator').style.display = 'none';

                    // Mettre à jour la carte 2D
                    if (map && markerLayer && !window.is3DView) {
                        // Stocker l'ID du marqueur actif avant de rafraîchir
                        var previousActiveId = activeMarkerId;

                        // Rafraîchir les marqueurs
                        markerLayer.clearLayers();
                        await addMarkersToMap();
                        console.log('Marqueurs mis à jour avec les nouvelles données (2D)');

                        // Si un marqueur était actif, le réactiver
                        if (previousActiveId !== null) {
                            setTimeout(function () {
                                zoomToStation(previousActiveId);
                            }, 300);
                        }
                    }

                    // Mettre à jour la carte 3D si elle est active
                    if (map3d && map3dInitialized && window.is3DView) {
                        // Rafraîchir les marqueurs 3D
                        refreshMarkers3D();
                        console.log('Marqueurs mis à jour avec les nouvelles données (3D)');
                    }
                }
            } catch (e) {
                console.error("Erreur lors de la mise à jour des données:", e);
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        // Fonction pour afficher l'indicateur de chargement
        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        // Fonction pour masquer l'indicateur de chargement
        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        // Fonction pour afficher les filtres
        function showFilters() {
            notifyNative('showFilters', {});
        }

        // Fonction pour centrer sur la position de l'utilisateur
        function centerOnUserLocation() {
            try {
                showLoading();

                if (window.is3DView && map3d) {
                    // Utiliser la géolocalisation de MapLibre
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;

                            map3d.flyTo({
                                center: [lng, lat],
                                zoom: 16,
                                pitch: 60,
                                bearing: 0,
                                duration: 1500 // Animation plus longue pour plus de fluidité
                            });

                            // Ajouter un marqueur pour la position de l'utilisateur
                            var el = document.createElement('div');
                            el.style.width = '16px';
                            el.style.height = '16px';
                            el.style.borderRadius = '50%';
                            el.style.backgroundColor = '#3388ff';
                            el.style.border = '3px solid white';
                            el.style.boxShadow = '0 0 8px rgba(0,0,0,0.5)';

                            var userMarker = new maplibregl.Marker(el)
                                .setLngLat([lng, lat])
                                .addTo(map3d);

                            // Supprimer le marqueur après 10 secondes
                            setTimeout(function () {
                                userMarker.remove();
                            }, 10000);

                            // Notifier l'application native
                            notifyNative('locationUpdated', { lat: lat, lng: lng });

                            hideLoading();
                        }, function (error) {
                            console.error('Erreur de géolocalisation:', error);
                            alert('Impossible d\'obtenir votre position. Vérifiez que la géolocalisation est activée.');
                            hideLoading();
                        });
                    } else {
                        alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
                        hideLoading();
                    }
                } else if (map) {
                    // Utiliser la géolocalisation de Leaflet
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            var lat = position.coords.latitude;
                            var lng = position.coords.longitude;

                            // Utiliser flyTo pour une animation plus fluide
                            map.flyTo([lat, lng], 15, {
                                animate: true,
                                duration: 1.2, // Durée plus longue pour une animation plus fluide
                                easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                            });

                            // Ajouter un marqueur pour la position de l'utilisateur
                            var userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    html: '<div style="background-color: #3388ff; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.5);"></div>',
                                    className: '',
                                    iconSize: [22, 22],
                                    iconAnchor: [11, 11]
                                })
                            }).addTo(map);

                            // Ajouter un cercle pour montrer la précision
                            var accuracyCircle = L.circle([lat, lng], {
                                radius: position.coords.accuracy || 100,
                                color: '#3388ff',
                                fillColor: '#3388ff',
                                fillOpacity: 0.15,
                                weight: 2
                            }).addTo(map);

                            // Supprimer le marqueur et le cercle après 10 secondes
                            setTimeout(function () {
                                map.removeLayer(userMarker);
                                map.removeLayer(accuracyCircle);
                            }, 10000);

                            // Notifier l'application native
                            notifyNative('locationUpdated', { lat: lat, lng: lng });

                            hideLoading();
                        }, function (error) {
                            console.error('Erreur de géolocalisation:', error);
                            alert('Impossible d\'obtenir votre position. Vérifiez que la géolocalisation est activée.');
                            hideLoading();
                        }, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    } else {
                        alert('La géolocalisation n\'est pas prise en charge par votre navigateur.');
                        hideLoading();
                    }
                } else {
                    console.error("Aucune carte n'est initialisée");
                    hideLoading();
                }
            } catch (e) {
                console.error("Erreur lors de la géolocalisation:", e);
                hideLoading();
            }
        }

        // Fonctions pour le zoom
        function zoomIn() {
            try {
                if (window.is3DView && map3d) {
                    map3d.easeTo({
                        zoom: map3d.getZoom() + 0.5,
                        duration: 300,
                        easing: function (t) {
                            return t * (2 - t); // Fonction d'accélération pour une animation plus douce
                        }
                    });
                } else if (map) {
                    map.zoomIn(0.5, {
                        animate: true,
                        duration: 0.3, // Durée plus courte pour une réponse plus rapide
                        easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du zoom avant:", e);
                return false;
            }
        }

        function zoomOut() {
            try {
                if (window.is3DView && map3d) {
                    map3d.easeTo({
                        zoom: map3d.getZoom() - 0.5,
                        duration: 300,
                        easing: function (t) {
                            return t * (2 - t); // Fonction d'accélération pour une animation plus douce
                        }
                    });
                } else if (map) {
                    map.zoomOut(0.5, {
                        animate: true,
                        duration: 0.3, // Durée plus courte pour une réponse plus rapide
                        easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du zoom arrière:", e);
                return false;
            }
        }

        // Fonction pour basculer entre les vues 2D et 3D
        function toggle3DView() {
            try {
                window.is3DView = !window.is3DView;

                if (window.is3DView) {
                    // Passer à la vue 3D
                    showLoading();

                    // Initialiser la carte 3D si ce n'est pas déjà fait
                    if (!map3dInitialized) {
                        initMap3D();
                    } else {
                        document.getElementById('map3d').style.display = 'block';

                        // Rafraîchir les marqueurs 3D
                        refreshMarkers3D();

                        // Afficher l'indicateur de mode 3D
                        var modeIndicator = document.getElementById('mode-indicator');
                        modeIndicator.style.display = 'block';
                        setTimeout(function () {
                            modeIndicator.style.opacity = '0';
                            setTimeout(function () {
                                modeIndicator.style.display = 'none';
                                modeIndicator.style.opacity = '1';
                            }, 300);
                        }, 3000);
                    }

                    // Masquer la carte 2D
                    document.getElementById('map').style.display = 'none';

                    // Notifier l'application native
                    notifyNative('viewChanged', { mode: '3D' });

                    hideLoading();
                    return true;
                } else {
                    // Revenir à la vue 2D
                    showLoading();

                    // Masquer la carte 3D
                    document.getElementById('map3d').style.display = 'none';

                    // Afficher la carte 2D
                    document.getElementById('map').style.display = 'block';

                    // Rafraîchir la carte 2D
                    if (map) {
                        map.invalidateSize();
                    }

                    // Notifier l'application native
                    notifyNative('viewChanged', { mode: '2D' });

                    hideLoading();
                    return false;
                }
            } catch (e) {
                console.error("Erreur lors du changement de vue:", e);
                hideLoading();
                return false;
            }
        }

        // Fonction pour recentrer la carte
        function centerMap() {
            try {
                // Si nous avons des stations, centrer sur les bornes
                if (stationData && stationData.length > 0) {
                    var validStations = stationData.filter(function (station) {
                        return station.lat && station.lng && !isNaN(parseFloat(station.lat)) && !isNaN(parseFloat(station.lng));
                    });

                    if (validStations.length > 0) {
                        if (window.is3DView && map3d) {
                            // Calculer le centre et les limites pour la carte 3D
                            var bounds = new maplibregl.LngLatBounds();
                            validStations.forEach(function (station) {
                                bounds.extend([parseFloat(station.lng), parseFloat(station.lat)]);
                            });

                            map3d.fitBounds(bounds, {
                                padding: 50,
                                duration: 1500, // Animation plus longue pour plus de fluidité
                                easing: function (t) {
                                    return t * (2 - t); // Fonction d'accélération pour une animation plus douce
                                }
                            });
                        } else if (map) {
                            // Calculer les limites pour la carte 2D
                            var bounds = L.latLngBounds();
                            validStations.forEach(function (station) {
                                bounds.extend([parseFloat(station.lat), parseFloat(station.lng)]);
                            });

                            map.flyToBounds(bounds, {
                                padding: [50, 50],
                                animate: true,
                                duration: 1.2, // Durée plus longue pour une animation plus fluide
                                easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                            });
                        }
                        return true;
                    }
                }

                // Si pas de stations valides, centrer sur une position par défaut (Annecy)
                if (window.is3DView && map3d) {
                    map3d.flyTo({
                        center: [6.129, 45.899],
                        zoom: 14,
                        duration: 1500, // Animation plus longue pour plus de fluidité
                        easing: function (t) {
                            return t * (2 - t); // Fonction d'accélération pour une animation plus douce
                        }
                    });
                } else if (map) {
                    map.flyTo([45.899, 6.129], 14, {
                        animate: true,
                        duration: 1.2, // Durée plus longue pour une animation plus fluide
                        easeLinearity: 0.15 // Valeur plus basse pour une animation plus douce
                    });
                }
                return true;
            } catch (e) {
                console.error("Erreur lors du recentrage de la carte:", e);
                return false;
            }
        }

        // Fonction pour zoomer sur une station spécifique
        async function zoomToStation(stationId) {
            try {
                console.log("Zoom to station: " + stationId);

                // Trouver la station correspondante
                var station = stationData.find(function (s) {
                    return s.id === parseInt(stationId) || s.borne_id === parseInt(stationId);
                });

                if (station) {
                    console.log("Station found:", station);

                    // Adapter les propriétés de la station si nécessaire
                    adaptStationProperties(station);

                    if (window.is3DView && map3d) {
                        // Zoomer sur la station en 3D
                        map3d.flyTo({
                            center: [parseFloat(station.lng), parseFloat(station.lat)],
                            zoom: 17,
                            pitch: 60,
                            bearing: Math.random() * 180 - 90, // Rotation aléatoire pour un effet dynamique
                            duration: 1000,
                            essential: true
                        });

                        // Trouver le marqueur 3D correspondant et ouvrir son popup
                        var marker3D = markers3D.find(function (m) {
                            return m.stationId === parseInt(stationId);
                        });

                        if (marker3D) {
                            setTimeout(function () {
                                marker3D.togglePopup();
                            }, 1000);
                        }
                    } else if (map) {
                        // Fermer tous les popups existants
                        closeAllPopups();

                        // Trouver le marqueur correspondant
                        var marker = markers.find(function (m) {
                            return m.options.stationId === parseInt(stationId);
                        });

                        if (marker) {
                            // Centrer la carte sur le marqueur et ouvrir son popup
                            centerMapAndOpenPopup(marker);
                        } else {
                            // Si le marqueur n'est pas trouvé, centrer sur les coordonnées de la station
                            map.flyTo([station.lat, station.lng], 16, {
                                animate: true,
                                duration: 0.8,
                                easeLinearity: 0.15
                            });
                        }
                    }

                    // Notifier l'application native
                    notifyNative('stationSelected', { id: stationId });

                    return true;
                } else {
                    console.error("Station not found with ID:", stationId);
                }

                return false;
            } catch (e) {
                console.error("Erreur lors du zoom sur la station:", e);
                return false;
            }
        }

        // Fonction pour naviguer vers une station
        async function navigateToStation(stationId) {
            try {
                console.log("Navigation vers la station: " + stationId);

                // Trouver la station correspondante
                var station = stationData.find(function (s) {
                    return s.id === parseInt(stationId) || s.borne_id === parseInt(stationId);
                });

                if (station) {
                    console.log("Station trouvée pour la navigation:", station);

                    // Adapter les propriétés de la station si nécessaire
                    adaptStationProperties(station);

                    // Construire l'adresse complète
                    var fullAddress = station.address || "";
                    if (station.postal_code && station.city) {
                        fullAddress += ', ' + station.postal_code + ' ' + station.city;
                    }

                    // Coordonnées pour la navigation
                    var lat = parseFloat(station.lat);
                    var lng = parseFloat(station.lng);

                    // Créer des liens directs pour Google Maps et Apple Maps
                    var googleMapsUrl = "https://www.google.com/maps/dir/?api=1&destination=" + lat + "," + lng;
                    var appleMapsUrl = "maps://?daddr=" + lat + "," + lng + "&dirflg=d";

                    // Déterminer la plateforme pour choisir le bon lien
                    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    var navigationUrl = isIOS ? appleMapsUrl : googleMapsUrl;

                    // Essayer d'ouvrir directement l'application de navigation
                    var linkElement = document.createElement('a');
                    linkElement.href = navigationUrl;
                    linkElement.target = '_blank';
                    linkElement.click();

                    // Notifier l'application native pour qu'elle gère l'ouverture de l'application de navigation
                    notifyNative('navigate', {
                        id: stationId,
                        address: fullAddress,
                        lat: lat,
                        lng: lng,
                        url: navigationUrl
                    });

                    return true;
                } else {
                    console.error("Station non trouvée avec l'ID:", stationId);
                }

                return false;
            } catch (e) {
                console.error("Erreur lors de la navigation vers la station:", e);
                return false;
            }
        }

        // Fonction pour communiquer avec l'application native
        function notifyNative(action, data) {
            try {
                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.jsBridge) {
                    // iOS
                    window.webkit.messageHandlers.jsBridge.postMessage({
                        action: action,
                        data: data
                    });
                } else if (window.jsBridge) {
                    // Android
                    window.jsBridge.receiveMessage(JSON.stringify({
                        action: action,
                        data: data
                    }));
                } else {
                    console.log("Communication bridge not found");
                }
            } catch (e) {
                console.error("Error notifying native app:", e);
            }
        }

        // Ajouter un gestionnaire d'erreurs
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('Erreur JavaScript:', message, 'à', source, ':', lineno);
            notifyNative('error', { message: message, source: source, line: lineno });
            return true;
        };

        // Exposer les fonctions pour l'interface native
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.toggle3DView = toggle3DView;
        window.centerMap = centerMap;
        window.centerOnUserLocation = centerOnUserLocation;
        window.zoomToStation = zoomToStation;
        window.initMap = initMap;
        window.showFilters = showFilters;
        window.navigateToStation = navigateToStation;
        window.updateStationData = updateStationData;
        window.closeAllPopups = closeAllPopups;

        // Initialiser la carte quand le DOM est chargé
        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOM chargé, initialisation de la carte");
            setTimeout(initMap, 500);
        });
    </script>
</body>
</html>